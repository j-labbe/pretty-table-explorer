---
phase: 08-data-export
plan: 01
type: execute
depends_on: []
files_modified: [src/export.rs, src/main.rs, Cargo.toml]
---

<objective>
Add CSV and JSON export functionality for the current table view.

Purpose: Allow users to save query results to files, respecting column visibility and display order.
Output: Working export with E key trigger, format selection, and file save.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-column-controls/07-04-SUMMARY.md

@src/parser.rs
@src/column.rs
@src/main.rs

**Tech stack:** Rust 2021, ratatui v0.29, crossterm v0.28
**Established patterns:**
- Modules: parser.rs, column.rs, update.rs, db.rs for focused functionality
- Keybindings: Uppercase letters for actions (H: hide, S: show all)
- ColumnConfig.visible_indices() returns columns in display order, filtered by visibility
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export module with CSV/JSON serialization</name>
  <files>src/export.rs, Cargo.toml</files>
  <action>
Create src/export.rs with export functions:

1. Add dependencies to Cargo.toml:
   - `serde = { version = "1", features = ["derive"] }`
   - `serde_json = "1"`
   - `csv = "1"`

2. Create export.rs with:
   - `pub enum ExportFormat { Csv, Json }` - enum for format selection
   - `pub fn export_table(data: &TableData, visible_cols: &[usize], format: ExportFormat) -> Result<String, String>` - serialize to string

For CSV:
- Use csv crate's Writer with wtr.write_record()
- First write headers (only visible columns in order)
- Then write each row (only visible columns in order)
- Return String from writer's into_inner()

For JSON:
- Create a Vec of row objects, each row is a HashMap<String, String> mapping header to value
- Only include visible columns
- Use serde_json::to_string_pretty()

3. Add `pub fn save_to_file(content: &str, path: &str) -> Result<(), String>` - write content to file with std::fs::write

Do NOT use any async patterns. This is synchronous file I/O.
  </action>
  <verify>cargo build --release succeeds with new module</verify>
  <done>export.rs compiles, exports TableData to CSV and JSON strings respecting visible columns</done>
</task>

<task type="auto">
  <name>Task 2: Add export keybinding and file dialog</name>
  <files>src/main.rs</files>
  <action>
Add export functionality to main.rs:

1. Add `mod export;` and `use export::{ExportFormat, export_table, save_to_file};`

2. Add AppMode variants for export flow:
   - `ExportFormat` - prompting for CSV vs JSON
   - `ExportFilename` - prompting for filename with text input

3. Add state fields:
   - `export_format: Option<ExportFormat>` - selected format
   - `export_filename: String` - filename being typed

4. Add keybinding in Normal mode (when viewing table):
   - `E` key -> enter ExportFormat mode

5. In ExportFormat mode:
   - Display: "Export format: [C]SV or [J]SON (Esc to cancel)"
   - `C` -> set export_format to Csv, enter ExportFilename mode
   - `J` -> set export_format to Json, enter ExportFilename mode
   - `Esc` -> return to Normal mode

6. In ExportFilename mode:
   - Display text input area for filename (default: "export.csv" or "export.json")
   - Character input appends to export_filename
   - Backspace removes last char
   - Enter:
     - Get visible_cols from column_config.visible_indices()
     - Call export_table with current table data
     - Call save_to_file with result
     - Show success/error message briefly (can reuse existing status message pattern if exists, or just return to Normal)
   - Esc -> cancel, return to Normal mode

7. Update title controls in Normal mode to show E for export

The export should use the CURRENT table data (either pipe_data or the selected query result), respecting the current column visibility and order from column_config.
  </action>
  <verify>cargo build --release succeeds, cargo test passes</verify>
  <done>E key triggers export flow, format selection works, filename input works, file is saved to disk</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cargo build --release` succeeds
- [ ] `cargo test` passes (18+ tests)
- [ ] No clippy warnings: `cargo clippy -- -D warnings`
- [ ] Export keybinding appears in title controls
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- E key triggers export format selection
- CSV export produces valid CSV with visible columns only
- JSON export produces valid JSON array with visible columns only
- Files saved successfully to specified path
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-export/08-01-SUMMARY.md`:

# Plan 08-01 Summary: Data Export

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/export.rs` - Description
- `src/main.rs` - Description
- `Cargo.toml` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 8 complete, ready for Phase 9 planning
</output>
