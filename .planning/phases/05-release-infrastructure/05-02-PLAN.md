---
phase: 05-release-infrastructure
plan: 02
type: execute
depends_on: ["05-01"]
files_modified: [.github/workflows/release.yml]
---

<objective>
Create GitHub Actions workflow for multi-platform release builds.

Purpose: Automate binary builds for distribution across Linux and macOS platforms.
Output: Workflow that builds and uploads release assets on git tag push.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-release-infrastructure/05-01-SUMMARY.md
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release workflow with build matrix</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create .github/workflows/release.yml with:

1. Trigger: on push tags matching 'v*' (e.g., v1.0.0)

2. Build matrix with 4 targets:
   - linux-x86_64: ubuntu-latest, x86_64-unknown-linux-gnu
   - linux-aarch64: ubuntu-latest, aarch64-unknown-linux-gnu (use cross)
   - macos-x86_64: macos-13, x86_64-apple-darwin
   - macos-aarch64: macos-14, aarch64-apple-darwin (native ARM runner)

3. Build steps per job:
   - Checkout code
   - Install Rust toolchain with target
   - Install cross-rs for Linux ARM only (cargo install cross)
   - Build with cargo (or cross for ARM Linux)
   - Rename binary to pte-{target} (e.g., pte-linux-x86_64, pte-macos-aarch64)
   - Upload artifact

4. Release job (needs: build):
   - Download all artifacts
   - Generate SHA256 checksums for each binary
   - Create GitHub Release using softprops/action-gh-release
   - Upload binaries and checksums.txt

Use GITHUB_TOKEN for release creation (automatic, no secrets needed).

For Linux ARM cross-compilation, install linker: `sudo apt-get install gcc-aarch64-linux-gnu`
Set CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
  </action>
  <verify>cat .github/workflows/release.yml && yamllint .github/workflows/release.yml 2>/dev/null || echo "yaml structure looks valid"</verify>
  <done>release.yml exists with matrix for 4 targets, checksum generation, and release upload</done>
</task>

<task type="auto">
  <name>Task 2: Add CI test workflow for PRs</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create .github/workflows/ci.yml for continuous integration:

1. Trigger: on push to main, on pull_request

2. Jobs:
   - test: Run cargo test on ubuntu-latest
   - build: Run cargo build --release to verify compilation
   - clippy: Run cargo clippy -- -D warnings
   - fmt: Run cargo fmt --check

3. Use dtolnay/rust-toolchain@stable for Rust installation
4. Use Swatinem/rust-cache@v2 for build caching

This ensures PRs are tested before merge, separate from release workflow.
  </action>
  <verify>cat .github/workflows/ci.yml</verify>
  <done>ci.yml exists with test, build, clippy, fmt jobs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .github/workflows/release.yml exists and is valid YAML
- [ ] .github/workflows/ci.yml exists and is valid YAML
- [ ] release.yml has matrix with 4 targets
- [ ] release.yml generates checksums
- [ ] release.yml creates GitHub release
- [ ] ci.yml runs on push/PR to main
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Workflows are valid YAML (no syntax errors)
- Release workflow covers all 4 target platforms
- Phase 5 complete - release infrastructure ready
</success_criteria>

<output>
After completion, create `.planning/phases/05-release-infrastructure/05-02-SUMMARY.md`
</output>
