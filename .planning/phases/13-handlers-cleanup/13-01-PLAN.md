---
phase: 13-handlers-cleanup
plan: 01
type: execute
depends_on: []
files_modified: [src/handlers.rs, src/main.rs]
---

<objective>
Extract keyboard input handlers from main.rs into a dedicated handlers.rs module.

Purpose: Reduce main.rs complexity by moving event handling logic to a separate module, improving maintainability.
Output: New handlers.rs module with handler functions, main.rs reduced by ~200 lines.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-ui-layer-extraction/12-02-SUMMARY.md
@src/main.rs
@src/state.rs
@src/workspace.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create handlers module with key event types</name>
  <files>src/handlers.rs</files>
  <action>Create src/handlers.rs with:

1. Define a `KeyAction` enum to represent the result of handling a key:
   - `None` - no action needed
   - `Quit` - exit the application
   - `StatusMessage(String)` - display a status message
   - `CreateTab { name: String, data: TableData, view_mode: ViewMode }` - create a new tab
   - `ModeChange(AppMode)` - change input mode

2. Create `handle_normal_mode` function that takes:
   - `key: &KeyEvent`
   - `tab: &mut Tab`
   - `workspace: &mut Workspace`
   - `db_client: &mut Option<postgres::Client>`
   - `table_list_cache: &Option<TableData>`
   - `current_table_name: &mut Option<String>`
   - `displayed_row_count: usize`
   Returns `KeyAction`.

3. Create `handle_query_input` function that takes:
   - `key: &KeyEvent`
   - `input_buffer: &mut String`
   - `db_client: &mut Option<postgres::Client>`
   Returns `(KeyAction, bool)` where bool indicates mode should return to Normal.

4. Create `handle_search_input` function that takes:
   - `key: &KeyEvent`
   - `input_buffer: &mut String`
   - `tab: &mut Tab`
   Returns `bool` indicating mode should return to Normal.

5. Create `handle_export_format` function that takes:
   - `key: &KeyEvent`
   - `export_format: &mut Option<ExportFormat>`
   - `input_buffer: &mut String`
   Returns `Option<AppMode>` for next mode (None = stay, Some(Normal) = cancel, Some(ExportFilename) = proceed).

6. Create `handle_export_filename` function that takes:
   - `key: &KeyEvent`
   - `input_buffer: &mut String`
   - `export_format: Option<ExportFormat>`
   - `tab: &Tab`
   Returns `(Option<String>, bool)` where Option<String> is status message, bool is done.

Import required types: KeyEvent, KeyCode, KeyModifiers from crossterm, Tab and Workspace from workspace, TableData from parser, AppMode from state, ExportFormat from export, calculate_auto_widths from render, execute_query from db.

Note: Keep the handlers close to the original logic. Don't over-abstract - the goal is moving code, not redesigning it.</action>
  <verify>cargo build compiles without errors</verify>
  <done>src/handlers.rs exists with all handler functions defined and compiles successfully</done>
</task>

<task type="auto">
  <name>Task 2: Update main.rs to use handlers module</name>
  <files>src/main.rs</files>
  <action>Update main.rs:

1. Add `mod handlers;` declaration after other mod statements
2. Add `use handlers::{KeyAction, handle_normal_mode, handle_query_input, handle_search_input, handle_export_format, handle_export_filename};`
3. Replace the match arm for `AppMode::Normal` with call to `handle_normal_mode` and match on returned `KeyAction`
4. Replace the match arm for `AppMode::QueryInput` with call to `handle_query_input`
5. Replace the match arm for `AppMode::SearchInput` with call to `handle_search_input`
6. Replace the match arm for `AppMode::ExportFormat` with call to `handle_export_format`
7. Replace the match arm for `AppMode::ExportFilename` with call to `handle_export_filename`

The main loop should now look like:
```rust
match current_mode {
    AppMode::Normal => {
        match handle_normal_mode(&key, tab, &mut workspace, &mut db_client, &table_list_cache, &mut current_table_name, displayed_row_count) {
            KeyAction::Quit => break,
            KeyAction::StatusMessage(msg) => { status_message = Some(msg); status_message_time = Some(Instant::now()); }
            KeyAction::CreateTab { name, data, view_mode } => { pending_action = PendingAction::CreateTab { name, data, view_mode }; }
            KeyAction::ModeChange(mode) => { current_mode = mode; }
            KeyAction::None => {}
        }
    }
    // ... similar for other modes
}
```

Note: workspace needs to be borrowed mutably in normal mode for tab switching, so handle_normal_mode must take &mut Workspace. However, the tab borrow from focused_tab_mut() happens inside main, so we need to pass workspace separately and let the handler call workspace methods directly for operations that don't need the tab borrow.

Actually, simpler approach: Since the handler needs both workspace access and tab access, and we can't hold both borrows, structure it so:
- Pass tab reference where needed
- For workspace-only operations (toggle_split, toggle_focus, switch_to, etc.), call those in main.rs based on returned action

Adjust KeyAction to include workspace operations:
- `WorkspaceAction(WorkspaceOp)` where WorkspaceOp is ToggleSplit, ToggleFocus, NextTab, PrevTab, SwitchTo(usize), CloseTab

This keeps the borrow checker happy while still moving most logic to handlers.</action>
  <verify>cargo build succeeds, cargo test passes all tests</verify>
  <done>main.rs uses handlers module, compiles and tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify refactoring</name>
  <files>src/main.rs, src/handlers.rs</files>
  <action>Run verification:
1. cargo build --release
2. cargo test
3. cargo clippy
4. Verify main.rs line count reduced (target: under 800 lines)
5. Verify handlers.rs contains the handler functions</action>
  <verify>All commands pass, main.rs under 800 lines</verify>
  <done>Refactoring verified: builds, tests pass, main.rs reduced</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all 32 tests
- [ ] `cargo clippy` shows no new warnings
- [ ] main.rs line count reduced by ~200+ lines
- [ ] handlers.rs exists with handler functions
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- main.rs reduced to under 800 lines
- Handler logic moved to handlers.rs module
</success_criteria>

<output>
After completion, create `.planning/phases/13-handlers-cleanup/13-01-SUMMARY.md`:

# Phase 13 Plan 01: Handler Module Extraction Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/handlers.rs` - Description
- `src/main.rs` - Description

## Task Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | hash | description |
| Task 2 | hash | description |
| Task 3 | (none) | Verification - no commit needed |

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 13-02-PLAN.md (clippy fixes and dead code removal)
</output>
