---
phase: 12-ui-layer-extraction
plan: 01
type: execute
depends_on: []
files_modified: [src/render.rs, src/main.rs]
---

<objective>
Extract table rendering functions from main.rs into a dedicated render.rs module.

Purpose: Isolate the ~350 lines of rendering logic into a focused module, reducing main.rs complexity and improving maintainability.
Output: New src/render.rs module with table rendering functions, main.rs updated to use it.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-core-types-extraction/11-01-SUMMARY.md

Relevant source files:
@src/main.rs
@src/state.rs (PaneRenderData struct)
@src/workspace.rs (Tab struct)
@src/column.rs (ColumnConfig)
@src/parser.rs (TableData)

**Tech stack:** Rust 2021, ratatui v0.29, crossterm v0.28
**Pattern from Phase 11:** Extract to separate module, update imports in main.rs

**Functions to extract:**
- `calculate_auto_widths` (lines 76-96) - raw column width calculation
- `calculate_widths` (lines 101-118) - width calculation with config overrides
- `build_pane_render_data` (lines 121-162) - prepare render data from tab
- `render_table_pane` (lines 164-416) - core table rendering with scroll indicators
- `build_pane_title` (lines 418-466) - pane title construction
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create render.rs module with rendering functions</name>
  <files>src/render.rs</files>
  <action>
Create src/render.rs with the following functions extracted from main.rs:

1. Add module documentation and imports:
   ```rust
   //! Table rendering functions for the terminal UI.
   //!
   //! Contains functions for calculating column widths, building render data,
   //! and rendering table panes with scroll indicators.

   use std::cell::Cell as StdCell;
   use ratatui::{
       prelude::*,
       widgets::{Block, Borders, Cell, Paragraph, Row, Table, TableState},
   };
   use crate::column::ColumnConfig;
   use crate::parser::TableData;
   use crate::state::PaneRenderData;
   use crate::workspace::{Tab, ViewMode};
   ```

2. Extract `calculate_auto_widths(data: &TableData) -> Vec<u16>` - lines 76-96
   - Keep as `pub(crate)` since only needed within crate

3. Extract `calculate_widths(data: &TableData, config: Option<&ColumnConfig>) -> Vec<Constraint>`
   - lines 101-118
   - Make `pub(crate)`

4. Extract `build_pane_render_data(tab: &Tab) -> PaneRenderData` - lines 121-162
   - Make `pub` since it's used in main loop
   - Change workspace::Tab to Tab in parameter type

5. Extract `render_table_pane` function - lines 164-416
   - Make `pub`
   - Keep same signature: (frame, area, pane, title, is_focused, table_state, last_visible_col_idx)

6. Extract `build_pane_title` function - lines 418-466
   - Make `pub`
   - Keep same signature

**Important:** Preserve all existing logic exactly - this is a pure extraction refactor.
  </action>
  <verify>File exists at src/render.rs with all 5 functions and proper imports</verify>
  <done>src/render.rs contains calculate_auto_widths, calculate_widths, build_pane_render_data, render_table_pane, build_pane_title with correct signatures</done>
</task>

<task type="auto">
  <name>Task 2: Update main.rs to use render module</name>
  <files>src/main.rs</files>
  <action>
Update main.rs to use the new render module:

1. Add module declaration after `mod state;`:
   ```rust
   mod render;
   ```

2. Remove the following function definitions from main.rs (they're now in render.rs):
   - `calculate_auto_widths` (lines 76-96)
   - `calculate_widths` (lines 101-118)
   - `build_pane_render_data` (lines 121-162)
   - `render_table_pane` (lines 164-416)
   - `build_pane_title` (lines 418-466)

3. Update imports to use render module. Add to existing use statements:
   ```rust
   use render::{build_pane_render_data, build_pane_title, render_table_pane, calculate_auto_widths};
   ```
   Note: calculate_widths is only used by calculate_auto_widths and build_pane_render_data, both now in render.rs

4. In the event handling section, update the two calls to `calculate_auto_widths`:
   - Line ~1181: `let auto_widths = calculate_auto_widths(&tab.data);`
   - Line ~1190: `let auto_widths = calculate_auto_widths(&tab.data);`
   These should work with the import above.

5. The main render closure already calls these functions by name - no changes needed there since imports bring them into scope.

**Expected reduction:** ~350 lines removed from main.rs
  </action>
  <verify>cargo build compiles without errors, cargo test passes all 32 tests</verify>
  <done>main.rs no longer contains the 5 extracted functions, render module is imported and used, build and tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify and fix any issues</name>
  <files>src/render.rs, src/main.rs</files>
  <action>
Run verification and fix any issues:

1. Run `cargo build` - fix any compilation errors
2. Run `cargo test` - ensure all 32 tests pass
3. Run `cargo clippy` - address any new warnings (existing warnings OK)

Common issues to watch for:
- Import visibility: ensure `Tab` is accessible from workspace module (`use crate::workspace::Tab`)
- StdCell import in render.rs for last_visible_col_idx parameter
- Constraint type from ratatui::prelude
  </action>
  <verify>cargo build, cargo test, and cargo clippy all succeed</verify>
  <done>Build succeeds, all 32 tests pass, no new clippy warnings</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all 32 tests
- [ ] `cargo clippy` shows no new warnings
- [ ] src/render.rs exists with 5 rendering functions
- [ ] main.rs no longer contains the extracted functions
- [ ] Application runs correctly: `cat export.csv | cargo run` displays table
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- main.rs reduced by ~350 lines
- render.rs contains isolated rendering logic
- No functional changes to application behavior
</success_criteria>

<output>
After completion, create `.planning/phases/12-ui-layer-extraction/12-01-SUMMARY.md`:

# Phase 12 Plan 01: Render Module Extraction Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- Created src/render.rs module with table rendering functions
- Extracted calculate_auto_widths, calculate_widths, build_pane_render_data, render_table_pane, build_pane_title
- Updated main.rs imports to use render module
- Reduced main.rs by ~350 lines

## Files Created/Modified

- `src/render.rs` - New module (X lines)
- `src/main.rs` - Removed function definitions, added render module import

## Task Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | [hash] | refactor(12-01): create render module with table rendering functions |
| Task 2 | [hash] | refactor(12-01): update main.rs to use render module |
| Task 3 | (if needed) | fix(12-01): [description of fix] |

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 12-02-PLAN.md (main loop UI extraction) or Phase 12 complete if no more plans.
</output>
