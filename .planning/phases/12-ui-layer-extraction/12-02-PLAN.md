---
phase: 12-ui-layer-extraction
plan: 02
type: execute
depends_on: ["12-01"]
files_modified: [src/render.rs, src/main.rs]
---

<objective>
Extract main loop UI layout and rendering logic into organized render module functions.

Purpose: Move the ~200 lines of inline render closure logic from main() into named functions in render.rs, making the main loop focused on event handling.
Output: Cleaner main loop, render.rs with layout/UI helper functions.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-ui-layer-extraction/12-01-SUMMARY.md

Relevant source files:
@src/main.rs (after 12-01 extraction)
@src/render.rs (created in 12-01)
@src/state.rs (AppMode enum)
@src/workspace.rs (ViewMode, Workspace)

**Depends on 12-01:** render.rs module exists with core rendering functions

**Code blocks to extract from main loop (lines ~771-976):**
- Tab bar building logic (lines ~626-647)
- Control hints building (lines ~798-806, ~872-929)
- Input bar rendering (lines ~948-964)
- Format prompt rendering (lines ~966-975)
- Split view layout logic (lines ~807-879)
- Single pane layout logic (lines ~880-945)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UI helper functions to render.rs</name>
  <files>src/render.rs</files>
  <action>
Add helper functions to render.rs for building UI elements:

1. Add `build_tab_bar` function:
   ```rust
   /// Build tab bar string for multi-tab display.
   /// Format: "1:name 2:name [3:active] 4:name | " with numbers matching keyboard shortcuts.
   pub fn build_tab_bar(workspace: &Workspace) -> String {
       let tab_count = workspace.tab_count();
       let is_split = workspace.split_active && tab_count > 1;
       if tab_count > 1 {
           let names: Vec<String> = workspace.tabs.iter().enumerate().map(|(i, t)| {
               // Truncate long tab names to prevent title overflow
               let name = if t.name.len() > 15 {
                   format!("{}...", &t.name[..12])
               } else {
                   t.name.clone()
               };
               // Mark both active and split tabs in split mode
               if is_split && i == workspace.split_idx && i != workspace.active_idx {
                   format!("<{}:{}>", i + 1, name)
               } else if i == workspace.active_idx {
                   format!("[{}:{}]", i + 1, name)
               } else {
                   format!("{}:{}", i + 1, name)
               }
           }).collect();
           format!("{} | ", names.join(" "))
       } else {
           String::new()
       }
   }
   ```

2. Add `build_controls_hint` function:
   ```rust
   /// Build context-appropriate controls hint string.
   pub fn build_controls_hint(
       view_mode: ViewMode,
       is_split: bool,
       tab_count: usize,
   ) -> String {
       let split_controls = if is_split {
           "Tab: switch pane, V: unsplit, "
       } else if tab_count > 1 {
           "V: split, "
       } else {
           ""
       };
       let tab_controls = if tab_count > 1 { "1-9: tab, W: close, " } else { "" };

       match view_mode {
           ViewMode::TableList => format!("{}{}Enter: select, /: filter, q: quit", split_controls, tab_controls),
           ViewMode::TableData => format!("{}{}+/-: width, H/S: hide/show, </>: move, E: export, 0: reset, Esc: back, q: quit", split_controls, tab_controls),
           ViewMode::PipeData => format!("{}{}+/-: width, H/S: hide/show, </>: move, E: export, 0: reset, q: quit", split_controls, tab_controls),
       }
   }
   ```

3. Add `render_input_bar` function:
   ```rust
   /// Render input bar for query/search/export modes.
   pub fn render_input_bar(frame: &mut Frame, area: Rect, mode: AppMode, input_buffer: &str) {
       let (prefix, style) = match mode {
           AppMode::QueryInput => (":", Style::default().fg(Color::Cyan)),
           AppMode::SearchInput => ("/", Style::default().fg(Color::Yellow)),
           AppMode::ExportFilename => ("Save as: ", Style::default().fg(Color::Green)),
           AppMode::Normal | AppMode::ExportFormat => ("", Style::default()),
       };

       let input_text = format!("{}{}", prefix, input_buffer);
       let input_widget = Paragraph::new(input_text)
           .style(style)
           .block(Block::default().borders(Borders::ALL));

       frame.render_widget(input_widget, area);
   }
   ```

4. Add `render_format_prompt` function:
   ```rust
   /// Render export format selection prompt.
   pub fn render_format_prompt(frame: &mut Frame, area: Rect) {
       let prompt_text = "Export format: [C]SV or [J]SON (Esc to cancel)";
       let prompt_widget = Paragraph::new(prompt_text)
           .style(Style::default().fg(Color::Green))
           .block(Block::default().borders(Borders::ALL));

       frame.render_widget(prompt_widget, area);
   }
   ```

5. Update imports at top of render.rs to include:
   - `use crate::workspace::Workspace;`
   - `use crate::state::AppMode;`
   - Ensure `Color` is imported from ratatui
  </action>
  <verify>cargo build compiles without errors</verify>
  <done>render.rs contains build_tab_bar, build_controls_hint, render_input_bar, render_format_prompt functions</done>
</task>

<task type="auto">
  <name>Task 2: Update main.rs to use new helper functions</name>
  <files>src/main.rs</files>
  <action>
Update main.rs main loop to use the new helper functions:

1. Update render import to include new functions:
   ```rust
   use render::{
       build_pane_render_data, build_pane_title, render_table_pane,
       calculate_auto_widths, build_tab_bar, build_controls_hint,
       render_input_bar, render_format_prompt,
   };
   ```

2. Replace inline tab bar building (lines ~626-647) with:
   ```rust
   let tab_bar = build_tab_bar(&workspace);
   let tab_count = workspace.tab_count();
   let is_split = workspace.split_active && tab_count > 1;
   ```

3. Inside the render closure, replace the split view controls building (around line ~872):
   - Before: inline match statement building controls string
   - After: `let controls = build_controls_hint(current_view, is_split, tab_count);`

4. Inside the render closure, replace single pane controls building (around line ~922-929):
   - Use `build_controls_hint` call

5. Replace input bar rendering (lines ~949-963) with:
   ```rust
   if show_input_bar {
       render_input_bar(frame, chunks[1], mode, &input_buf);
   }
   ```

6. Replace format prompt rendering (lines ~967-975) with:
   ```rust
   if show_format_prompt {
       render_format_prompt(frame, chunks[1]);
   }
   ```

**Note:** Some inline logic in the single pane branch builds a more elaborate title with position info. Keep that inline for now - it's specific to single pane mode and uses local variables. The goal is to extract reusable, generic UI helpers.
  </action>
  <verify>cargo build compiles, cargo test passes all 32 tests</verify>
  <done>main.rs uses helper functions from render module, inline UI code reduced</done>
</task>

<task type="auto">
  <name>Task 3: Verify and test application</name>
  <files>src/render.rs, src/main.rs</files>
  <action>
Run full verification:

1. Run `cargo build` - ensure no compilation errors
2. Run `cargo test` - all 32 tests must pass
3. Run `cargo clippy` - no new warnings
4. Manual test: `echo -e "a|b|c\n1|2|3\n4|5|6" | cargo run` - verify table displays
5. Manual test: Press 'E' to verify export format prompt appears correctly
6. Manual test: Press '/' to verify search input bar appears correctly
  </action>
  <verify>All commands pass, manual testing shows correct UI behavior</verify>
  <done>Build, tests, clippy pass; UI renders correctly for all modes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all 32 tests
- [ ] `cargo clippy` shows no new warnings
- [ ] Tab bar displays correctly in multi-tab mode
- [ ] Controls hints display correctly for each view mode
- [ ] Input bar renders correctly in search/query modes
- [ ] Export format prompt renders correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Render module contains UI helper functions
- Main loop is cleaner with less inline rendering code
- No functional changes to application behavior
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-ui-layer-extraction/12-02-SUMMARY.md`:

# Phase 12 Plan 02: Main Loop UI Extraction Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- Added build_tab_bar, build_controls_hint, render_input_bar, render_format_prompt to render.rs
- Updated main.rs to use new helper functions
- Reduced inline rendering code in main loop

## Files Created/Modified

- `src/render.rs` - Added 4 UI helper functions
- `src/main.rs` - Replaced inline UI code with function calls

## Task Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | [hash] | refactor(12-02): add UI helper functions to render module |
| Task 2 | [hash] | refactor(12-02): update main.rs to use render helpers |
| Task 3 | (if needed) | fix(12-02): [description of fix] |

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 12 complete, ready for Phase 13 (Handlers & Cleanup).
</output>
