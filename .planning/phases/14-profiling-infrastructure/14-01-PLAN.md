---
phase: 14-profiling-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib.rs
  - src/main.rs
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Crate modules are accessible from external tests and benchmarks via library target"
    - "Developer can run cargo run --features dhat-heap to produce heap profile"
    - "Panic hook is extracted to a named function and called before terminal init"
    - "Cargo profiles include debug symbols enabling flamegraph generation (profile.release has debug = line-tables-only, profile.bench has debug = true)"
  artifacts:
    - path: "src/lib.rs"
      provides: "Library crate re-exporting all public modules"
      contains: "pub mod parser"
    - path: "Cargo.toml"
      provides: "Criterion dev-dependency, dhat optional dependency, profile configs with debug symbols for flamegraphs"
      contains: "criterion"
  key_links:
    - from: "src/lib.rs"
      to: "src/parser.rs"
      via: "pub mod re-export"
      pattern: "pub mod parser"
    - from: "src/main.rs"
      to: "src/lib.rs"
      via: "use pretty_table_explorer::"
      pattern: "use pretty_table_explorer::"
    - from: "Cargo.toml"
      to: "src/lib.rs"
      via: "lib target"
      pattern: "\\[lib\\]"
    - from: "Cargo.toml"
      to: "flamegraph tooling"
      via: "profile.release debug symbols enable cargo-flamegraph to resolve symbols"
      pattern: 'debug = "line-tables-only"'
---

<objective>
Create library crate for external access, add profiling dependencies, extract panic hook, and configure Cargo profiles for profiling (including flamegraph support).

Purpose: All other Phase 14 plans (benchmarks, integration tests) require modules to be accessible via a library crate. This plan establishes that foundation plus the dhat heap profiling capability, Cargo profile configs that enable flamegraph generation, and panic hook improvement.
Output: src/lib.rs exposing modules, Cargo.toml with Criterion/dhat/profiles (flamegraph-ready), refactored panic hook
</objective>

<execution_context>
@/home/jlabbe/.claude/get-shit-done/workflows/execute-plan.md
@/home/jlabbe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-profiling-infrastructure/14-RESEARCH.md
@src/main.rs
@src/parser.rs
@src/export.rs
@src/column.rs
@src/workspace.rs
@src/render.rs
@src/state.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create library crate and configure Cargo.toml</name>
  <files>src/lib.rs, Cargo.toml</files>
  <action>
1. Create src/lib.rs that re-exports all modules needed by tests and benchmarks:
   ```rust
   pub mod parser;
   pub mod column;
   pub mod export;
   pub mod state;
   pub mod workspace;
   pub mod render;
   pub mod handlers;
   pub mod db;
   pub mod update;
   ```
   Note: These modules already use `pub` on their types/functions. The lib.rs just needs to make the modules themselves public.

2. Update Cargo.toml to add:
   - `[lib]` section with `name = "pretty_table_explorer"` and `path = "src/lib.rs"`
   - Keep existing `[[bin]]` section unchanged
   - Add `[dev-dependencies]` section with `criterion = { version = "0.5", features = ["html_reports"] }` (use 0.5 which is the latest stable on crates.io, NOT 0.8 which does not exist yet -- research may be wrong about version)
   - Add `[dependencies]` entry: `dhat = { version = "0.3", optional = true }`
   - Add `[features]` section: `dhat-heap = ["dhat"]`
   - Add Criterion bench harness config:
     ```toml
     [[bench]]
     name = "parsing"
     harness = false

     [[bench]]
     name = "rendering"
     harness = false

     [[bench]]
     name = "scrolling"
     harness = false
     ```
   - Add profile configurations that enable flamegraph generation and profiling:
     ```toml
     [profile.release]
     debug = "line-tables-only"

     [profile.bench]
     debug = true
     ```
     These profile settings are critical: `debug = "line-tables-only"` in release profile ensures `cargo flamegraph` can resolve function names in the generated flamegraph SVG. Without debug symbols, flamegraphs show only memory addresses. The bench profile gets full debug info for detailed profiling during benchmarks.

3. Update src/main.rs module declarations to use the library crate instead of local mod declarations:
   - Remove all `mod` declarations at the top (column, db, export, handlers, parser, render, state, update, workspace)
   - Replace with `use pretty_table_explorer::{parser, column, db, export, handlers, render, state, update, workspace};`
   - Keep all existing `use` statements that reference specific types from these modules, but update paths from `crate::` to `pretty_table_explorer::` if needed (though since main.rs uses `use handlers::...` etc. which will resolve through the `use` import, this should work as-is)
   - IMPORTANT: The render module has `pub(crate)` functions (calculate_auto_widths, calculate_widths). These need to become `pub` in render.rs so they are accessible through the library crate. Update those two function signatures in src/render.rs from `pub(crate)` to `pub`.

IMPORTANT: After making changes, run `cargo check` to verify compilation. The binary and library targets must both compile. Fix any visibility or path issues that arise -- the most common issue will be `crate::` paths in module files that need to remain as `crate::` (they refer to the lib crate root, which is correct).
  </action>
  <verify>
Run `cargo check` -- must compile with zero errors.
Run `cargo check --features dhat-heap` -- must compile with dhat feature enabled.
Verify Cargo.toml contains `[profile.release]` with `debug = "line-tables-only"` -- this is the config that enables flamegraph symbol resolution.
  </verify>
  <done>
src/lib.rs exists and re-exports all modules. Cargo.toml has Criterion dev-dep, dhat optional dep, bench configs, and profile configs (release with debug = "line-tables-only" for flamegraph support, bench with debug = true). Both `cargo check` and `cargo check --features dhat-heap` succeed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dhat heap profiling support and extract panic hook</name>
  <files>src/main.rs</files>
  <action>
1. Add dhat global allocator at the top of main.rs (after use statements, before any function):
   ```rust
   #[cfg(feature = "dhat-heap")]
   #[global_allocator]
   static ALLOC: dhat::Alloc = dhat::Alloc;
   ```

2. Add dhat profiler initialization at the very start of the main function body (before any other code):
   ```rust
   #[cfg(feature = "dhat-heap")]
   let _profiler = dhat::Profiler::new_heap();
   ```

3. Extract the inline panic hook (currently at ~line 222-228) into a named function `init_panic_hook()`:
   ```rust
   /// Install panic hook that restores terminal state before printing panic message.
   /// Must be called BEFORE terminal initialization.
   fn init_panic_hook() {
       let original_hook = std::panic::take_hook();
       std::panic::set_hook(Box::new(move |panic_info| {
           let _ = disable_raw_mode();
           let _ = execute!(io::stdout(), LeaveAlternateScreen, DisableMouseCapture);
           original_hook(panic_info);
       }));
   }
   ```
   Then replace the inline code with `init_panic_hook();` at the same location (before `init_terminal()`).

4. Verify the panic hook is called BEFORE init_terminal() -- this is already the case in the current code, just maintain that ordering.

Run `cargo check` and `cargo check --features dhat-heap` to confirm compilation.
  </action>
  <verify>
Run `cargo check` -- compiles without errors.
Run `cargo check --features dhat-heap` -- compiles without errors.
Run `cargo build --features dhat-heap` -- binary builds successfully.
  </verify>
  <done>
dhat global allocator is conditionally compiled behind dhat-heap feature. Panic hook is extracted to init_panic_hook() function. Both regular and dhat-heap builds compile successfully.
  </done>
</task>

</tasks>

<verification>
1. `cargo check` passes (library + binary targets compile)
2. `cargo check --features dhat-heap` passes (dhat feature works)
3. `cargo test` passes (existing tests still work, if any)
4. src/lib.rs exists with pub mod declarations for all modules
5. Cargo.toml has [lib], [dev-dependencies], [features], [[bench]], and [profile.*] sections
6. Cargo.toml [profile.release] contains `debug = "line-tables-only"` -- enables `cargo flamegraph` to produce readable flamegraphs with resolved function names
7. main.rs uses library crate imports instead of local mod declarations
8. Panic hook is in a named function called before terminal init
</verification>

<success_criteria>
- Library crate compiles and exposes parser, column, export, workspace, render, state, handlers modules
- `cargo check --features dhat-heap` succeeds
- All three bench targets declared in Cargo.toml (parsing, rendering, scrolling)
- Profile configs enable debug symbols for profiling and flamegraph generation (release: line-tables-only, bench: full debug)
- Panic hook extracted to named function
</success_criteria>

<output>
After completion, create `.planning/phases/14-profiling-infrastructure/14-01-SUMMARY.md`
</output>
