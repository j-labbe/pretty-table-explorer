---
phase: 14-profiling-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/search_tests.rs
  - tests/export_tests.rs
  - tests/column_tests.rs
autonomous: true

must_haves:
  truths:
    - "Integration tests verify search filtering finds correct rows and handles edge cases"
    - "Integration tests verify CSV and JSON export produce correct output with column visibility"
    - "Integration tests verify column operations (hide, show, reorder, resize) work correctly"
    - "All integration tests pass with cargo test"
  artifacts:
    - path: "tests/search_tests.rs"
      provides: "Integration tests for search/filter functionality"
      contains: "fn test_search"
    - path: "tests/export_tests.rs"
      provides: "Integration tests for CSV and JSON export"
      contains: "fn test_export"
    - path: "tests/column_tests.rs"
      provides: "Integration tests for column configuration operations"
      contains: "fn test_column"
  key_links:
    - from: "tests/search_tests.rs"
      to: "src/parser.rs"
      via: "use pretty_table_explorer::parser"
      pattern: "pretty_table_explorer::parser::parse_psql"
    - from: "tests/export_tests.rs"
      to: "src/export.rs"
      via: "use pretty_table_explorer::export"
      pattern: "pretty_table_explorer::export::export_table"
    - from: "tests/column_tests.rs"
      to: "src/column.rs"
      via: "use pretty_table_explorer::column"
      pattern: "pretty_table_explorer::column::ColumnConfig"
---

<objective>
Create comprehensive integration tests for search, export, and column operations to prevent regressions during Phase 16 storage refactoring.

Purpose: Phase 16 will change the core data storage from Vec<Vec<String>> to a compact format. These tests ensure that search filtering, CSV/JSON export, and column hide/show/reorder/resize all continue working correctly after that change. This is the highest-risk mitigation for the v1.4 milestone.
Output: Three test files in tests/ that run via `cargo test`
</objective>

<execution_context>
@/home/jlabbe/.claude/get-shit-done/workflows/execute-plan.md
@/home/jlabbe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-profiling-infrastructure/14-RESEARCH.md
@.planning/phases/14-profiling-infrastructure/14-01-SUMMARY.md
@src/parser.rs
@src/export.rs
@src/column.rs
@src/workspace.rs
@src/render.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search and export integration tests</name>
  <files>tests/search_tests.rs, tests/export_tests.rs</files>
  <action>
**tests/search_tests.rs:**

Create integration tests for the search/filter functionality. Search filtering happens via the Tab's filter_text field -- when build_pane_render_data is called, it filters rows where any cell contains the filter text (case-insensitive).

1. Define a constant SAMPLE_PSQL_OUTPUT with realistic psql-formatted data (~10 rows, 4 columns) including varied content for testing (names, numbers, mixed case).

2. Write tests:
   - `test_parse_and_filter_matching_rows`: Parse sample data, create Tab, set filter_text to a value that matches 2-3 rows, call build_pane_render_data, assert display_rows.len() matches expected count.
   - `test_filter_case_insensitive`: Set filter to lowercase version of an uppercase value, verify match found.
   - `test_filter_no_matches`: Set filter to "zzzznonexistent", verify display_rows.len() == 0.
   - `test_filter_empty_string`: Empty filter_text should return all rows (no filtering).
   - `test_filter_partial_match`: Filter "ali" should match "Alice" rows.
   - `test_parse_empty_input`: parse_psql("") returns None.
   - `test_parse_single_row`: Parse data with exactly one data row, verify headers and row count.
   - `test_parse_multiline_psql`: Parse data with the standard psql footer "(N rows)" line, verify it's excluded from data rows.

Import: `pretty_table_explorer::parser::parse_psql`, `pretty_table_explorer::workspace::{Tab, ViewMode}`, `pretty_table_explorer::render::build_pane_render_data`

**tests/export_tests.rs:**

Create integration tests for CSV and JSON export functionality.

1. Write tests:
   - `test_export_csv_all_columns`: Create TableData, export with all column indices visible, verify CSV output has correct header row and data rows. Check for UTF-8 BOM prefix (\u{FEFF}).
   - `test_export_csv_subset_columns`: Export with only columns [0, 2] visible, verify only those columns appear in output.
   - `test_export_json_all_columns`: Export as JSON, parse the output with serde_json, verify array of objects with correct keys and values.
   - `test_export_json_subset_columns`: Export JSON with column subset, verify only selected columns in output.
   - `test_export_csv_special_characters`: Data containing commas, quotes, newlines -- verify proper CSV escaping.
   - `test_export_empty_table`: TableData with headers but no rows, verify export produces header-only CSV / empty JSON array.

Import: `pretty_table_explorer::parser::TableData`, `pretty_table_explorer::export::{export_table, ExportFormat}`

For creating test TableData directly (not parsing):
```rust
let data = TableData {
    headers: vec!["id".into(), "name".into(), "age".into()],
    rows: vec![
        vec!["1".into(), "Alice".into(), "30".into()],
        vec!["2".into(), "Bob".into(), "25".into()],
    ],
};
```
  </action>
  <verify>
Run `cargo test --test search_tests` -- all search tests pass.
Run `cargo test --test export_tests` -- all export tests pass.
  </verify>
  <done>
tests/search_tests.rs has 8+ tests covering filter matching, case insensitivity, edge cases, and parsing. tests/export_tests.rs has 6+ tests covering CSV/JSON export with column subsets and special characters. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create column operation integration tests</name>
  <files>tests/column_tests.rs</files>
  <action>
Create integration tests for column configuration operations (hide, show, reorder, resize).

Write tests:
   - `test_column_config_new`: Create ColumnConfig::new(5), verify all 5 columns visible, visible_count() == 5.
   - `test_column_hide`: Hide column 2, verify visible_count() == 4, visible_indices() excludes 2.
   - `test_column_show_all`: Hide columns 1 and 3, then show_all(), verify all visible again.
   - `test_column_hide_show_preserves_order`: Hide col 2, check visible_indices order is [0,1,3,4]. Show all, check order restored.
   - `test_column_reorder_swap`: Create config with 5 cols, swap_display(1, 3), verify display_position changes.
   - `test_column_resize_width`: Call adjust_width(col, +5, auto_width=10), verify get_width returns 15.
   - `test_column_resize_minimum`: Call adjust_width with negative delta that would go below minimum (3), verify width stays at minimum.
   - `test_column_resize_no_override`: get_width on fresh config returns None (auto-size).
   - `test_column_reset`: Modify several columns (hide, resize, reorder), call reset(), verify everything back to defaults.
   - `test_column_visibility_with_export`: Create TableData and ColumnConfig, hide a column, get visible_indices(), pass to export_table, verify hidden column excluded from output.

Import: `pretty_table_explorer::column::ColumnConfig`, `pretty_table_explorer::parser::TableData`, `pretty_table_explorer::export::{export_table, ExportFormat}`

The last test is a critical cross-module integration test -- it verifies that column visibility correctly feeds into export, which is exactly the kind of wiring that Phase 16 storage changes could break.
  </action>
  <verify>
Run `cargo test --test column_tests` -- all column tests pass.
Run `cargo test` -- all tests across all suites pass (search, export, column, plus any existing unit tests).
  </verify>
  <done>
tests/column_tests.rs has 10+ tests covering hide, show, reorder, resize, reset, and cross-module integration with export. All tests pass via `cargo test`.
  </done>
</task>

</tasks>

<verification>
1. `cargo test --test search_tests` passes all search/filter tests
2. `cargo test --test export_tests` passes all export tests
3. `cargo test --test column_tests` passes all column tests
4. `cargo test` passes all tests (unit + integration) with zero failures
5. Tests cover the three critical areas identified as regression risks for Phase 16: search, export, column operations
6. No compiler warnings in test files
</verification>

<success_criteria>
- Three test files exist in tests/ directory
- At least 24 integration tests across the three files
- Tests cover: parsing, filtering, case insensitivity, edge cases, CSV export, JSON export, column subset export, column hide/show/reorder/resize, cross-module integration
- All tests pass with `cargo test`
- Tests use the library crate API (pretty_table_explorer::*) not internal module paths
</success_criteria>

<output>
After completion, create `.planning/phases/14-profiling-infrastructure/14-03-SUMMARY.md`
</output>
