---
phase: 09-multiple-tables
plan: 03-FIX
type: fix
---

<objective>
Fix 3 UAT issues with multi-tab and split view functionality.

Source: 09-03-ISSUES.md
Root cause: `view_mode` is global but should be per-tab. Each tab needs its own ViewMode.
Priority: 0 critical, 3 major, 0 minor
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/09-multiple-tables/09-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/09-multiple-tables/09-03-PLAN.md

**Key files:**
- src/main.rs - Global view_mode variable, key handlers, render loop
- src/workspace.rs - Tab struct needs view_mode field
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add view_mode field to Tab struct</name>
  <files>src/workspace.rs</files>
  <action>
1. Add `use crate::ViewMode;` import at top (or define ViewMode in workspace.rs and re-export from main)
2. Add `pub view_mode: ViewMode` field to Tab struct
3. Update Tab::new() to accept view_mode parameter and store it
4. Update workspace tests if they call Tab::new() directly
  </action>
  <verify>cargo build --release compiles (may have errors from main.rs until Task 2)</verify>
  <done>Tab struct has view_mode field, Tab::new takes view_mode parameter</done>
</task>

<task type="auto">
  <name>Task 2: Migrate global view_mode to per-tab</name>
  <files>src/main.rs</files>
  <action>
1. Move ViewMode enum definition to workspace.rs (before Tab struct) so workspace.rs can use it
2. In main.rs: `use workspace::ViewMode;` instead of defining locally
3. Remove global `view_mode` variable from main.rs
4. Update workspace.add_tab() calls to pass view_mode:
   - Initial tab creation (line ~643): Pass the initial view_mode
   - PendingAction::CreateTab: Add view_mode field to enum variant
   - Query result tab creation (line ~1371): Pass ViewMode::TableData
   - Table selection tab creation (line ~1061): Pass ViewMode::TableData
5. Replace all `view_mode` references with `tab.view_mode` where `tab` is the focused tab
6. For the initial `table_list_cache` check, use the initial view_mode before workspace creation

Key locations to update:
- Line ~627: table_list_cache check - use initial mode variable before workspace
- Line ~638-643: Initial tab creation - pass mode to add_tab
- Line ~885-887: Title controls - use focused tab's view_mode
- Line ~934-939: Split pane controls - use each pane's tab view_mode
- Line ~1028: Enter key - use tab.view_mode
- Line ~1083: Esc key - use tab.view_mode and update tab.view_mode
- Line ~1092: Esc sets view_mode - update tab.view_mode instead
- Line ~1272: Export check - use tab.view_mode
- Line ~1523: New tab creation sets view_mode - update new tab's view_mode (already handled by add_tab)
  </action>
  <verify>cargo build --release compiles without errors</verify>
  <done>No global view_mode, all mode checks use tab.view_mode</done>
</task>

<task type="auto">
  <name>Task 3: Fix table_list_cache for back navigation</name>
  <files>src/main.rs</files>
  <action>
The table_list_cache stores the table list for back navigation (Esc from TableData to TableList).
Currently it's global. With per-tab view_mode, when pressing Esc:
1. The current tab's view_mode changes from TableData to TableList
2. The tab's data is restored from table_list_cache
3. This should work correctly now that view_mode is per-tab

Verify the Esc handler:
- Gets focused tab
- Checks tab.view_mode == ViewMode::TableData
- Restores tab data from table_list_cache
- Sets tab.view_mode = ViewMode::TableList

If table_list_cache needs to be per-connection (it does - it's the table list for THIS db connection), ensure it's used correctly. Since we have one db_client, one table_list_cache is fine.
  </action>
  <verify>Build and run: connect to DB, select table, press Esc, verify table list shows, press Enter, verify table loads</verify>
  <done>Esc back navigation works, Enter on table list works after Esc</done>
</task>

<task type="auto">
  <name>Task 4: Verify tab switching and split view</name>
  <files>src/main.rs</files>
  <action>
With per-tab view_mode, verify:
1. Tab key switches between tabs - each tab shows correct data AND correct controls
2. In split view, each pane shows controls appropriate to ITS tab's view_mode
3. Right pane tab can be changed with Tab/Shift+Tab when right pane is focused
4. Number keys (1-9) switch to correct tab with correct view_mode behavior

Test scenarios:
- Create 2 tabs (one TableList, one TableData)
- Switch between them with Tab key - controls should change appropriately
- Enable split view (V)
- Switch focus (Ctrl+W)
- Change right pane's tab (Tab key while right focused)
  </action>
  <verify>cargo test passes, manual testing confirms all tab switching scenarios work</verify>
  <done>Tab switching shows correct data and controls, split view pane switching works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] cargo build --release succeeds
- [ ] cargo test passes (32 tests)
- [ ] Tab switching works - shows correct data AND controls for each tab's mode
- [ ] Split view works - each pane has independent controls
- [ ] Right pane can be changed in split view
- [ ] Enter works on TableList after switching from TableData tab
- [ ] Esc back navigation works in split view
</verification>

<success_criteria>
- All 3 UAT issues from 09-03-ISSUES.md fixed
- view_mode is per-tab, not global
- Tests pass
- Ready for re-verification with /gsd:verify-work 09-03
</success_criteria>

<output>
After completion, create `.planning/phases/09-multiple-tables/09-03-FIX-SUMMARY.md`
</output>
