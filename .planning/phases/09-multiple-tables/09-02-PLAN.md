---
phase: 09-multiple-tables
plan: 02
type: execute
depends_on: ["09-01"]
files_modified: [src/main.rs, src/workspace.rs]
---

<objective>
Add tab creation from queries and tab navigation keybindings.

Purpose: Enable users to open query results in new tabs and switch between them.
Output: Working multi-tab workflow with Tab/number keys for switching, new tab creation.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-multiple-tables/09-01-SUMMARY.md
@src/main.rs
@src/workspace.rs

**From Plan 01:**
- Workspace struct manages Vec<Tab> with active_idx
- Tab holds data, column_config, filter_text, table_state, scroll offsets
- Tab bar renders in title when >1 tab
- Methods: add_tab, next_tab, prev_tab, switch_to, close_tab
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tab navigation keybindings</name>
  <files>src/main.rs</files>
  <action>
In AppMode::Normal key handling, add:

1. Tab switching with Tab/Shift+Tab:
   ```rust
   KeyCode::Tab => {
       if workspace.tab_count() > 1 {
           workspace.next_tab();
       }
   }
   KeyCode::BackTab => {  // Shift+Tab
       if workspace.tab_count() > 1 {
           workspace.prev_tab();
       }
   }
   ```

2. Direct tab selection with number keys 1-9:
   ```rust
   KeyCode::Char(c @ '1'..='9') => {
       let idx = (c as usize) - ('1' as usize);
       if idx < workspace.tab_count() {
           workspace.switch_to(idx);
       }
   }
   ```

3. Close current tab with 'W' (uppercase):
   ```rust
   KeyCode::Char('W') => {
       if workspace.tab_count() > 1 {
           workspace.close_tab(workspace.active_idx);
       }
   }
   ```

Update controls hint in title to include tab controls when >1 tab:
- Change controls string to conditionally include "Tab: switch, W: close tab"
  </action>
  <verify>With multiple tabs: Tab/Shift+Tab cycles, 1-9 jumps to tab, W closes current tab</verify>
  <done>Tab navigation works with Tab, Shift+Tab, number keys, and W to close</done>
</task>

<task type="auto">
  <name>Task 2: Open query results in new tab</name>
  <files>src/main.rs</files>
  <action>
Modify query execution (AppMode::QueryInput Enter handler) to create new tab instead of replacing current:

1. When query succeeds and returns data:
   ```rust
   // Generate tab name from query (truncate if long)
   let tab_name = {
       let q = query.trim();
       if q.len() > 20 {
           format!("{}...", &q[..17])
       } else {
           q.to_string()
       }
   };

   // Add as new tab and switch to it
   let new_idx = workspace.add_tab(tab_name, data);
   workspace.switch_to(new_idx);
   ```

2. This replaces the current behavior of overwriting table_data.

3. Update status message to indicate new tab created:
   ```rust
   status_message = Some(format!("Opened in tab {}", new_idx + 1));
   ```

Note: Table selection (Enter in TableList mode) should also create new tab. Update that handler similarly:
- Generate tab name from table name
- Add as new tab and switch to it
- Update view_mode to TableData for the new tab

Keep track of ViewMode per-tab or globally - for now keep it global since it affects navigation behavior.
  </action>
  <verify>Run query with : creates new tab. Select table with Enter creates new tab. Tab count increases.</verify>
  <done>Queries and table selections open in new tabs, original tab preserved</done>
</task>

<task type="auto">
  <name>Task 3: Update tab bar styling and add index numbers</name>
  <files>src/main.rs</files>
  <action>
Enhance tab bar rendering for better usability:

1. Show tab index number (1-based) with each tab name:
   ```rust
   let tab_bar = if workspace.tab_count() > 1 {
       let names: Vec<String> = workspace.tabs.iter().enumerate().map(|(i, t)| {
           let name = if t.name.len() > 15 {
               format!("{}...", &t.name[..12])
           } else {
               t.name.clone()
           };
           if i == workspace.active_idx {
               format!("[{}:{}]", i + 1, name)
           } else {
               format!("{}:{}", i + 1, name)
           }
       }).collect();
       format!("{} | ", names.join(" "))
   } else {
       String::new()
   };
   ```

2. Truncate long tab names to prevent title overflow.

3. Update help text when multiple tabs:
   - Add "1-9: tab" to controls when tab_count > 1
  </action>
  <verify>Tab bar shows "1:name 2:name [3:name]" format. Numbers correspond to keys. Long names truncated.</verify>
  <done>Tab bar shows numbered tabs, active tab bracketed, names truncated appropriately</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] cargo build --release succeeds
- [ ] In DB mode: : query opens new tab
- [ ] In DB mode: Enter on table opens new tab
- [ ] Tab/Shift+Tab cycles through tabs
- [ ] Number keys 1-9 jump to corresponding tab
- [ ] W closes current tab (when >1 tab)
- [ ] Tab bar shows numbered tabs with current bracketed
- [ ] Original tab contents preserved when opening new tabs
</verification>

<success_criteria>
- Tab navigation works (Tab, Shift+Tab, 1-9, W)
- Queries create new tabs instead of replacing
- Table selection creates new tabs
- Tab bar shows numbers matching keyboard shortcuts
- Multiple independent table views can be maintained
</success_criteria>

<output>
After completion, create `.planning/phases/09-multiple-tables/09-02-SUMMARY.md`
</output>
