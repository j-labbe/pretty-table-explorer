---
phase: 09-multiple-tables
plan: 01
type: execute
depends_on: []
files_modified: [src/workspace.rs, src/main.rs]
---

<objective>
Add workspace/tab data structure and basic tab bar rendering.

Purpose: Establish the foundation for managing multiple query results as named tabs.
Output: Workspace module with tab management, tab bar visible in UI.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/main.rs
@src/parser.rs
@src/column.rs

**Architecture context:**
- TableData holds parsed data (headers, rows)
- ColumnConfig tracks per-table column state (width, visibility, order)
- ViewMode enum controls navigation behavior (TableList, TableData, PipeData)
- Single table_data variable currently holds the active table
- State variables: table_state, column_config, scroll_col_offset, selected_visible_col

**Phase goal:**
Transform from single-table viewing to multi-tab workspace where each tab holds its own TableData + ColumnConfig + filter state.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace module with Tab and Workspace structs</name>
  <files>src/workspace.rs</files>
  <action>
Create new module `src/workspace.rs` with:

1. `Tab` struct containing:
   - `name: String` (tab label, e.g. "users", "Query 1")
   - `data: TableData` (the table content)
   - `column_config: ColumnConfig` (per-tab column state)
   - `filter_text: String` (per-tab filter)
   - `table_state: TableState` (row selection)
   - `scroll_col_offset: usize`
   - `selected_visible_col: usize`

2. `Workspace` struct containing:
   - `tabs: Vec<Tab>`
   - `active_idx: usize`

3. Workspace methods:
   - `new() -> Self` (empty workspace)
   - `add_tab(name: String, data: TableData) -> usize` (returns new tab index)
   - `active_tab(&self) -> Option<&Tab>`
   - `active_tab_mut(&mut self) -> Option<&mut Tab>`
   - `switch_to(&mut self, idx: usize)` (clamp to valid range)
   - `next_tab(&mut self)` (wrap around)
   - `prev_tab(&mut self)` (wrap around)
   - `close_tab(&mut self, idx: usize)` (adjust active_idx if needed)
   - `tab_count(&self) -> usize`
   - `tab_names(&self) -> Vec<&str>` (for rendering tab bar)

Note: Tab struct needs TableState from ratatui - import `ratatui::widgets::TableState`.
ColumnConfig comes from local module, TableData from parser module.
  </action>
  <verify>cargo check passes with no errors</verify>
  <done>workspace.rs compiles with Tab and Workspace structs, all methods implemented</done>
</task>

<task type="auto">
  <name>Task 2: Integrate workspace into main, migrate single-table state</name>
  <files>src/main.rs</files>
  <action>
1. Add `mod workspace;` declaration and `use workspace::Workspace;`

2. Replace scattered state variables with Workspace:
   - Remove: `table_data`, `column_config`, `filter_text`, `table_state`, `scroll_col_offset`, `selected_visible_col`
   - Add: `let mut workspace = Workspace::new();`

3. After loading initial data (either from stdin or DB), create first tab:
   ```rust
   let tab_name = match view_mode {
       ViewMode::TableList => "Tables".to_string(),
       ViewMode::TableData => current_table_name.clone().unwrap_or("Query".to_string()),
       ViewMode::PipeData => "Data".to_string(),
   };
   workspace.add_tab(tab_name, table_data);
   ```

4. Update main loop to access state through workspace:
   - `let tab = workspace.active_tab_mut().unwrap();`
   - Replace `table_data` with `tab.data`
   - Replace `column_config` with `tab.column_config`
   - Replace `filter_text` with `tab.filter_text`
   - Replace `table_state` with `tab.table_state`
   - Replace `scroll_col_offset` with `tab.scroll_col_offset`
   - Replace `selected_visible_col` with `tab.selected_visible_col`

5. Update widths calculation to use active tab data:
   - Move widths calc inside loop or make it a method call

6. Keep existing view_mode and db_client separate (not per-tab).

Note: This is a refactor - functionality should remain identical. The app should work exactly as before but with state now organized in workspace.
  </action>
  <verify>cargo run with piped data works, cargo run --connect works, all navigation and column controls work</verify>
  <done>App works identically to before but state is managed through Workspace</done>
</task>

<task type="auto">
  <name>Task 3: Add tab bar rendering in title area</name>
  <files>src/main.rs</files>
  <action>
Modify the title/header area to show tabs when multiple tabs exist:

1. In the draw closure, after getting `table_name`:
   ```rust
   let tab_bar = if workspace.tab_count() > 1 {
       let names: Vec<String> = workspace.tabs.iter().enumerate().map(|(i, t)| {
           if i == workspace.active_idx {
               format!("[{}]", t.name)
           } else {
               t.name.clone()
           }
       }).collect();
       format!("{} | ", names.join(" "))
   } else {
       String::new()
   };
   ```

2. Prepend `tab_bar` to the title string so tabs appear at the start.

3. Keep existing title content (position info, controls) after tab bar.

Visual: `[Tab1] Tab2 Tab3 | ◀ Data ▶ [Row 1/100 Col 2/5] +/-: width...`

Note: Tab bar only shows when there's more than one tab. Single-tab usage looks identical to current behavior.
  </action>
  <verify>With multiple tabs (via query mode), tab bar shows in title. With single tab, no tab bar visible.</verify>
  <done>Tab bar renders showing all tabs with active tab bracketed, only visible when >1 tab</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] cargo build --release succeeds
- [ ] Piped data mode works: `echo "a|b\n---|---\n1|2\n(1 row)" | cargo run`
- [ ] DB mode works: `cargo run -- --connect "..."` shows tables, Enter selects, Esc returns
- [ ] All column controls work (+/-, H/S, </>, 0)
- [ ] Filter (/) works
- [ ] Query (:) works and updates table
- [ ] No visible changes in single-tab mode
</verification>

<success_criteria>
- Workspace module exists with Tab and Workspace structs
- Main app uses workspace for all table state
- App behavior unchanged from user perspective (single tab)
- Tab bar renders when multiple tabs exist
- All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/09-multiple-tables/09-01-SUMMARY.md`
</output>
