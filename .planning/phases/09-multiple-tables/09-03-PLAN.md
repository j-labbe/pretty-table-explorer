---
phase: 09-multiple-tables
plan: 03
type: execute
depends_on: ["09-02"]
files_modified: [src/main.rs, src/workspace.rs]
---

<objective>
Add split view to display two tables side by side.

Purpose: Enable comparing query results or viewing related data simultaneously.
Output: Toggle split view with 'V', second pane shows different tab.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-multiple-tables/09-02-SUMMARY.md
@src/main.rs
@src/workspace.rs

**From Plans 01-02:**
- Workspace manages multiple tabs with navigation
- Tab bar shows numbered tabs
- Queries and table selections create new tabs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add split view state to workspace</name>
  <files>src/workspace.rs</files>
  <action>
Add split view management to Workspace:

1. Add fields to Workspace struct:
   ```rust
   pub split_active: bool,        // Is split view enabled
   pub split_idx: usize,          // Tab index shown in right pane
   pub focus_left: bool,          // Which pane has focus (true = left/main)
   ```

2. Initialize in Workspace::new():
   ```rust
   split_active: false,
   split_idx: 0,
   focus_left: true,
   ```

3. Add methods:
   ```rust
   pub fn toggle_split(&mut self) {
       if self.tabs.len() > 1 {
           self.split_active = !self.split_active;
           if self.split_active {
               // Default right pane to next tab after active
               self.split_idx = (self.active_idx + 1) % self.tabs.len();
           }
       }
   }

   pub fn toggle_focus(&mut self) {
       if self.split_active {
           self.focus_left = !self.focus_left;
       }
   }

   pub fn focused_tab(&self) -> Option<&Tab> {
       if self.split_active && !self.focus_left {
           self.tabs.get(self.split_idx)
       } else {
           self.active_tab()
       }
   }

   pub fn focused_tab_mut(&mut self) -> Option<&mut Tab> {
       if self.split_active && !self.focus_left {
           self.tabs.get_mut(self.split_idx)
       } else {
           self.active_tab_mut()
       }
   }

   pub fn focused_idx(&self) -> usize {
       if self.split_active && !self.focus_left {
           self.split_idx
       } else {
           self.active_idx
       }
   }
   ```

4. Update close_tab to handle split_idx:
   ```rust
   pub fn close_tab(&mut self, idx: usize) {
       if self.tabs.len() <= 1 { return; }
       self.tabs.remove(idx);
       // Adjust active_idx
       if self.active_idx >= self.tabs.len() {
           self.active_idx = self.tabs.len() - 1;
       } else if self.active_idx > idx {
           self.active_idx -= 1;
       }
       // Adjust split_idx
       if self.split_idx >= self.tabs.len() {
           self.split_idx = self.tabs.len() - 1;
       } else if self.split_idx > idx {
           self.split_idx -= 1;
       }
       // Disable split if only one tab left
       if self.tabs.len() == 1 {
           self.split_active = false;
       }
   }
   ```
  </action>
  <verify>cargo check passes</verify>
  <done>Workspace has split view state and methods for toggle, focus, and focused tab access</done>
</task>

<task type="auto">
  <name>Task 2: Render split view layout</name>
  <files>src/main.rs</files>
  <action>
Modify rendering to show two panes when split is active:

1. Before the main terminal.draw(), determine layout:
   ```rust
   let is_split = workspace.split_active && workspace.tab_count() > 1;
   ```

2. Inside draw closure, create horizontal split layout when active:
   ```rust
   let main_chunks = if is_split {
       Layout::default()
           .direction(Direction::Horizontal)
           .constraints([Constraint::Percentage(50), Constraint::Percentage(50)])
           .split(table_area)
   } else {
       vec![table_area]
   };
   ```

3. Create a helper function or macro to render a single table pane:
   ```rust
   fn render_table_pane(
       frame: &mut Frame,
       area: Rect,
       tab: &Tab,
       widths: &[Constraint],
       is_focused: bool,
       // ... other params
   ) { ... }
   ```

4. For split view, render left pane with active_tab, right pane with split_idx tab:
   - Left pane: workspace.tabs[workspace.active_idx]
   - Right pane: workspace.tabs[workspace.split_idx]

5. Indicate focus with border style:
   - Focused pane: yellow border or double border
   - Unfocused pane: default border

6. Each pane gets its own table rendering with its tab's state.

Note: This is complex refactoring of the draw closure. Extract the table rendering into a reusable function that takes the tab and area.
  </action>
  <verify>With split enabled (V key), two panes visible. Each shows different tab content.</verify>
  <done>Split view renders two table panes side by side, each with its own tab content</done>
</task>

<task type="auto">
  <name>Task 3: Add split view keybindings</name>
  <files>src/main.rs</files>
  <action>
Add keybindings for split view control:

1. Toggle split view with 'V' (uppercase):
   ```rust
   KeyCode::Char('V') => {
       workspace.toggle_split();
   }
   ```

2. Switch focus between panes with Ctrl+W or F6:
   ```rust
   KeyCode::Char('w') if key.modifiers.contains(KeyModifiers::CONTROL) => {
       workspace.toggle_focus();
   }
   KeyCode::F(6) => {
       workspace.toggle_focus();
   }
   ```

3. Change tab in right pane (when focused):
   - When focus is on right pane, Tab/Shift+Tab changes split_idx instead of active_idx
   ```rust
   KeyCode::Tab => {
       if workspace.split_active && !workspace.focus_left {
           // Cycle right pane through tabs
           workspace.split_idx = (workspace.split_idx + 1) % workspace.tab_count();
       } else if workspace.tab_count() > 1 {
           workspace.next_tab();
       }
   }
   ```

4. Update all state-modifying operations to use focused_tab_mut():
   - Navigation (j/k, h/l)
   - Column controls (+/-, H/S, </>)
   - Filter (/)
   - Query (:) - always creates new tab

5. Update controls hint:
   - When split active: "V: unsplit, Ctrl+W: switch pane"
   - When not split and >1 tab: "V: split"
  </action>
  <verify>V toggles split. Ctrl+W switches focus. Operations affect focused pane.</verify>
  <done>Split view toggles with V, focus switches with Ctrl+W, navigation works per-pane</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] cargo build --release succeeds
- [ ] V key toggles split view on/off (requires 2+ tabs)
- [ ] Split shows two different tabs side by side
- [ ] Ctrl+W or F6 switches focus between panes
- [ ] Focused pane has distinct border style
- [ ] j/k navigation works in focused pane only
- [ ] h/l column navigation works in focused pane only
- [ ] Column controls (+/-, H/S) work in focused pane only
- [ ] Tab key in right pane cycles that pane's tab
- [ ] W closes focused pane's tab
</verification>

<success_criteria>
- Split view toggles with V key
- Two panes show different tabs simultaneously
- Focus switches between panes
- All operations respect focus
- Visual indication of focused pane
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-multiple-tables/09-03-SUMMARY.md`
</output>
